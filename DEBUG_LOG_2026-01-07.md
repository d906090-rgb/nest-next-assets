# Debug Log - tecai.ru - 07.01.2026

## Краткое описание сессии
Исправление критических ошибок на сайте tecai.ru, включая React Three Fiber (R3F) игру WantZavod.

---

## Проблема 1: Чёрный экран при запуске игры (R3F Error)

### Симптомы
- При нажатии "НАЧАТЬ СМЕНУ" сайт падал с чёрным экраном
- Ошибка в консоли: `R3F: Div is not part of the THREE namespace!`
- `THREE.WebGLRenderer: Context Lost`

### Причина
Ошибка в файле `components/FluidBackground.tsx` — нарушение правил хуков React.

**Проблемный код (строки 13-17):**
```tsx
const StarField = () => {
  const isGameActive = useStore(s => s.status === GameStatus.PLAYING);
  
  if (isGameActive) return null;  // ← ОШИБКА: return ПЕРЕД useMemo

  const stars = useMemo(() => { ... });  // ← Хук после условного return
```

### Решение
Переместить `useMemo` **перед** условным `return`:
```tsx
const StarField = () => {
  const isGameActive = useStore(s => s.status === GameStatus.PLAYING);
  
  const stars = useMemo(() => { ... }, []);  // Хуки ВСЕГДА первыми
  
  if (isGameActive) return null;  // Условный return после хуков
```

### Файл
`/var/www/www-root/data/www/tecai.ru/components/FluidBackground.tsx`

---

## Проблема 2: Text.preload is not a function

### Симптомы
- Чёрный экран при загрузке
- Ошибка: `TypeError: Text.preload is not a function`

### Причина
Функция `Text.preload()` была удалена в новых версиях `@react-three/drei`.

**Проблемный код:**
```tsx
import { Text } from '@react-three/drei';
Text.preload(RUSSIAN_FONT_URL);  // ← Не существует в новых версиях
```

### Решение
Удалить вызов `Text.preload()` — шрифт загрузится автоматически при первом использовании.

### Файл
`/var/www/www-root/data/www/tecai.ru/WantZavod/components/World/LevelManager.tsx` (строка 74)

---

## Проблема 3: Буквы отображались как кубики

### Симптомы
- Вместо букв (Х, О, Ч, У...) отображались цветные кубики

### Причина
Код был упрощён для оптимизации — буквы рендерились как `boxGeometry`:
```tsx
{data.type === ObjectType.LETTER && (
    <mesh>
        <boxGeometry args={[0.8, 0.8, 0.8]} />
    </mesh>
)}
```

### Решение
Заменить на компонент `<Text>` с отображением `data.value`:
```tsx
{data.type === ObjectType.LETTER && (
    <Text
        font={RUSSIAN_FONT_URL}
        fontSize={0.8}
        color={data.color}
        anchorX="center"
        anchorY="middle"
        outlineWidth={0.05}
        outlineColor="#000000"
    >
        {data.value}
    </Text>
)}
```

### Файл
`/var/www/www-root/data/www/tecai.ru/WantZavod/components/World/LevelManager.tsx` (строки 587-600)

---

## Проблема 4: Невидимые столкновения и несобираемые предметы

### Симптомы
- Игрок врезался в "невидимые" препятствия
- Синие монеты (GEM/коды) не собирались
- Буквы иногда пролетали мимо
- Счётчики (дистанция, коды) оставались на 0

### Причина
1. `zThreshold = 2.0` — слишком широкая зона коллизий по Z
2. `dx < 0.9` — слишком маленький радиус сбора
3. `playerPos.z` мог быть неопределён, если PlayerGroup не найден
4. Логика `inZZone` была асимметричной

**Проблемный код:**
```tsx
const zThreshold = 2.0;
const inZZone = (prevZ < playerPos.z + zThreshold) && (obj.position[2] > playerPos.z - zThreshold);
// ...
if (dx < 0.9) { ... }
```

### Решение
1. Явно установить `playerPos.z = 0` (игрок всегда на z=0)
2. Упростить проверку: объект в зоне если `z` между -1.5 и +1.5
3. Разные радиусы для препятствий (0.8) и предметов (1.3)

```tsx
// Player z is always 0 in this game
playerPos.z = 0;

// Check if object passed through player zone
const objZ = obj.position[2];
const passedPlayer = prevZ <= 1.5 && objZ >= -1.5;

if (passedPlayer) {
    const dx = Math.abs(obj.position[0] - playerPos.x);
    const isDamageSource = obj.type === ObjectType.OBSTACLE || ...;
    const collisionRadius = isDamageSource ? 0.8 : 1.3;
    if (dx < collisionRadius) { ... }
}
```

### Файл
`/var/www/www-root/data/www/tecai.ru/WantZavod/components/World/LevelManager.tsx` (строки 265-345)

---

## Проблема 5: Кэширование и старые файлы

### Симптомы
- После изменений в коде сайт показывал старую версию
- В консоли загружался старый JS файл (`index-1SyDNIWX.js`)

### Причина
1. Vite кэширует файлы в `node_modules/.vite`
2. PM2 процесс не перезапускался корректно
3. `index.html` указывал на старый бандл

### Решение
При каждом изменении:
```bash
pkill -f "vite"
rm -rf dist node_modules/.vite
npm run build
npm start
```

В браузере: `Ctrl+Shift+R` (жёсткая перезагрузка)

---

## Созданные бэкапы

```
/var/www/www-root/data/www/tecai.ru/WantZavod/App.tsx.backup
/var/www/www-root/data/www/tecai.ru/WantZavod/components/World/LevelManager.tsx.backup
/var/www/www-root/data/www/tecai.ru/components/FluidBackground.tsx.backup
```

**Откат:**
```bash
cp LevelManager.tsx.backup LevelManager.tsx
```

---

## Ключевые файлы проекта

| Файл | Описание |
|------|----------|
| `App.tsx` | Главный компонент сайта с GlobalErrorBoundary |
| `WantZavod/App.tsx` | Точка входа игры, Canvas, Scene |
| `WantZavod/components/World/LevelManager.tsx` | Спавн объектов, коллизии, сбор предметов |
| `WantZavod/components/World/Player.tsx` | Игрок, управление, прыжки |
| `WantZavod/components/World/Environment.tsx` | Фон, звёзды, сетка |
| `WantZavod/components/UI/HUD.tsx` | Интерфейс игры, меню, магазин |
| `WantZavod/store.ts` | Zustand store, состояние игры |
| `components/FluidBackground.tsx` | Анимированный фон сайта |

---

## Полезные команды

```bash
# Пересборка проекта
cd /var/www/www-root/data/www/tecai.ru
pkill -f "vite"
rm -rf dist node_modules/.vite
npm run build
npm start

# Dev-сервер (для отладки с полными ошибками)
npm run dev -- --host 127.0.0.1 --port 10000

# Проверить что сервер работает
curl -s http://127.0.0.1:10000/ | grep -o 'index-[A-Za-z0-9_-]*\.js'
```

---

## Важные правила React/R3F

1. **Хуки всегда первыми** — `useState`, `useMemo`, `useEffect` должны быть ДО любого `return`
2. **Не использовать HTML внутри Canvas** — только Three.js примитивы (`mesh`, `group`, `Text` из drei)
3. **Text.preload удалён** — шрифты загружаются автоматически
4. **Очищать кэш Vite** — `rm -rf node_modules/.vite dist`

---

## Текущий статус (конец сессии)

- ✅ Сайт работает
- ✅ Игра запускается
- ✅ Буквы отображаются как текст
- ⚠️ Коллизии настроены, требуется финальное тестирование
- ⚠️ Сбор предметов настроен, требуется проверка

---

*Лог создан: 07.01.2026*
